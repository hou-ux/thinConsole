class thinConsole{constructor(t={}){if(thinConsole.tC)return this.warn("[thinConsole] thinConsole实例已存在"),thinConsole.tC;switch(t=this.sanitizeOptions(t),thinConsole.tC=this,this.version="1.0.5",this.options={text:"thinConsole",color:"#007aff",width:"auto",height:"auto",theme:"auto",plugins:!0,disabledPlugins:[],jsExecute:!0,maxLog:1e3,...t},this.options.theme){case"light":this.currentTheme="light";break;case"dark":this.currentTheme="dark";break;default:let t=()=>window.matchMedia("(prefers-color-scheme:dark)").matches?"dark":"light";this.currentTheme=t(),this.mediaQuery=window.matchMedia("(prefers-color-scheme:dark)"),this.themeChangeHandler=t=>{this.currentTheme=t.matches?"dark":"light",this.overlay&&this.overlay.classList.contains("active")&&(this.overlay.className="overlay active theme-"+this.currentTheme)},this.mediaQuery.addEventListener("change",this.themeChangeHandler)}this.currentTab="console",void 0===t.pos?.x&&void 0===t.pos?.y&&(this.options.pos=this.getSavedBtnPos()||{x:30,y:30}),this.pluginEnabled=this.options.plugins,this.disabledPlugins=this.options.disabledPlugins,this.plugins={},this.pluginTabs={},this.pluginViewContainers={},this.logs=[],this.systemLogs=[],this.lastLog=null,this.maxLog=this.options.maxLog,this.jsonPageSize=200,this.lsJsonPageSize=200,this.jsonPageCache=new Map,this.jsonPageIndex=new Map,this.lsJsonPageIndex=new Map,this.timerMap=new Map,this.countMap=new Map,this.createStyles(),this.createButton(),this.captureConsoleLogs(),this.createNotificationElement(),this.createOverlayElement(),this.setupGlobalEventHandlers(),this.setupSelfProtection(),this.initShortcuts(),this.renderContent()}getSavedBtnPos(){let t=localStorage.getItem("tC-Button-pos");if(!t)return this.saveBtnPos({x:30,y:30}),null;let e=t.match(/^x:(.+?)\,y:(.+)$/);if(!e)return this.saveBtnPos({x:30,y:30}),null;let o=Number(e[1]),s=Number(e[2]);return isNaN(o)||isNaN(s)?(this.saveBtnPos({x:30,y:30}),null):{x:o,y:s}}saveBtnPos({x:t,y:e}){t=isNaN(Number(t))?30:Number(t),e=isNaN(Number(e))?30:Number(e),localStorage.setItem("tC-Button-pos",`x:${t},y:${e}`)}sanitizeOptions(t){let e={text:"thinConsole",color:"#007aff",width:"auto",height:"auto",theme:"auto",plugins:!0,disabledPlugins:[],jsExecute:!0,pos:null,maxLog:1e3};if(!t||"object"!=typeof t)return{...e};let o={...e},s=(t,e=200)=>"string"==typeof t&&t.length<=e&&!/[<>"&]/.test(t)?t:void 0;for(let i of Object.keys(t)){if(!(i in e))continue;let n=t[i];switch(i){case"text":case"color":case"width":case"height":case"theme":{let t=s(n);void 0!==t&&(o[i]=t);break}case"plugins":case"jsExecute":"boolean"==typeof n&&(o[i]=n);break;case"disabledPlugins":Array.isArray(n)&&n.every(t=>"string"==typeof t)&&(o[i]=n.slice(0,100));case"pos":n&&"object"==typeof n&&"number"==typeof n.x&&"number"==typeof n.y&&(o.pos={x:n.x,y:n.y});break;case"maxLog":{let e=Number(t[i]);!isNaN(e)&&e>0&&(o[i]=Math.floor(e));break}}}return o}createButton(){this.btn=document.createElement("button"),this.btn.id="thinConsole-btn",this.btn.className="floating-console-btn",this.btn.textContent=this.options.text.slice(0,11),this.btn.style.background=this.options.color,this.btn.style.width=this.options.width,this.btn.style.height=this.options.height,this.btn.style.bottom=(Number(this.options.pos.y)||30)+"px",this.btn.style.right=(Number(this.options.pos.x)||30)+"px",this.btn.title=this.options.text.slice(0,11),document.documentElement.append(this.btn);let t=!1,e=0,o=0,s=0,i=0,n=0,a=0,r=null,l=null,c=0,d=0,h=()=>{r&&(clearTimeout(r),r=null)},g=()=>{if(!t)return;let e=c-s,o=d-i;this.btn.style.transform=`translate3d(${e}px,${o}px,0)`,l=requestAnimationFrame(g)},p=r=>{if(!t)return;let l=r.touches?r.touches[0]:r,h=l.clientX-e,g=l.clientY-o;c=Math.max(n/2,Math.min(innerWidth-n/2,s+h)),d=Math.max(a/2,Math.min(innerHeight-a/2,i+g)),r.preventDefault()},u=()=>{if(h(),!t)return;t=!1,cancelAnimationFrame(l);let e=this.btn.getBoundingClientRect(),o=Math.round(innerWidth-e.right),s=Math.round(innerHeight-e.bottom);this.btn.style.right=Math.max(0,o)+"px",this.btn.style.bottom=Math.max(0,s)+"px",this.saveBtnPos({x:Math.max(0,o),y:Math.max(0,s)}),this.btn.style.transform="",this.btn.dataset.right=Math.max(0,o),this.btn.dataset.bottom=Math.max(0,s),this.btn.removeEventListener("touchmove",p,{passive:!1}),this.btn.removeEventListener("touchend",u),this.btn.removeEventListener("mousemove",p),this.btn.removeEventListener("mouseup",u)},f=l=>{let h=l.touches?l.touches[0]:l;e=h.clientX,o=h.clientY;let f=this.btn.getBoundingClientRect();n=f.width,a=f.height,s=f.left+n/2,i=f.top+a/2,r=setTimeout(()=>{t=!0,c=s,d=i,g(),this.btn.addEventListener("touchmove",p,{passive:!1}),this.btn.addEventListener("touchend",u),this.btn.addEventListener("mousemove",p),this.btn.addEventListener("mouseup",u)},500)};this.btn.addEventListener("touchstart",f,{passive:!1}),this.btn.addEventListener("mousedown",f),this.btn.addEventListener("touchend",h),this.btn.addEventListener("mouseup",h),this.btn.addEventListener("mouseleave",h),this.btn.addEventListener("click",()=>{this.triggerGlobalHook("beforeOpen"),this.overlay.className="overlay active theme-"+this.currentTheme,this.renderContent(),this.triggerGlobalHook("afterOpen")})}createOverlayElement(){this.overlay=document.createElement("div"),this.overlay.id="consoleOverlay",this.overlay.className="overlay",this.overlay.innerHTML=`<div class="console-container"><div class="console-header"><div class="console-title"><i class="fa fa-terminal"></i>${this.options.text.slice(0,11)}</div><button class="clear-all-btn" title="清除" id="clearLogsBtn"><i class="fa fa-trash-alt"></i></button><button class="close-btn" title="关闭" id="closeConsoleBtn"><i class="fa fa-times"></i></button></div><div class="tabs" id="tabsContainer"></div><div class="console-content" id="contentArea"><div class="controls" id="consoleControls"><div class="filters"><button class="filter-btn active" title="全部" data-type="all"><i class="fa fa-stream"></i>全部</button><button class="filter-btn" title="日志" data-type="log"><i class="fa fa-info"></i>日志</button><button class="filter-btn" title="信息" data-type="info"><i class="fa fa-info-circle"></i>信息</button><button class="filter-btn" title="警告" data-type="warn"><i class="fa fa-exclamation-triangle"></i>警告</button><button class="filter-btn" title="错误" data-type="error"><i class="fa fa-times-circle"></i>错误</button></div><div class="search-box" title="搜索日志..."><input type="text" id="searchInput" placeholder="搜索日志..."></div></div><div class="console-output" id="consoleOutput"></div><div class="localstorage-view" id="localstorageView" style="display:none"><div class="ls-header"><button id="addLSItemBtn" class="push-btn" title="添加新项"><i class="fa fa-plus"></i>添加新项</button></div><div class="ls-items" id="lsItems"></div></div><div class="system-logs" id="systemLogs" style="display:none"></div></div></div>`,document.querySelector("html").appendChild(this.overlay),this.tabButtonsContainer=this.overlay.querySelector("#tabsContainer"),this.createBuiltinTabs(),this.closeConsoleBtn=this.overlay.querySelector("#closeConsoleBtn"),this.consoleOutput=this.overlay.querySelector("#consoleOutput"),this.title=this.overlay.querySelector(".console-title"),this.localstorageView=this.overlay.querySelector("#localstorageView"),this.lsItems=this.overlay.querySelector("#lsItems"),this.systemLogsEl=this.overlay.querySelector("#systemLogs"),this.contentArea=this.overlay.querySelector("#contentArea"),this.filterButtons=this.overlay.querySelectorAll(".filter-btn"),this.searchInput=this.overlay.querySelector("#searchInput"),this.clearLogsBtn=this.overlay.querySelector("#clearLogsBtn"),this.tabButtons=this.overlay.querySelectorAll(".tab-btn"),this.consoleControls=this.overlay.querySelector("#consoleControls"),this.addLSItemBtn=this.overlay.querySelector("#addLSItemBtn"),this.closeConsoleBtn.addEventListener("click",()=>{this.triggerGlobalHook("beforeClose"),this.overlay.classList.remove("active"),this.triggerGlobalHook("afterClose")}),[this.consoleOutput,this.systemLogsEl].forEach(t=>t.addEventListener("scroll",()=>t.dataset.bottom=Math.max(0,t.scrollHeight-t.scrollTop-t.clientHeight))),this.lsItems.addEventListener("click",t=>{let e=t.target.closest(".ls-action-btn");if(!e)return;let o=e.dataset.action,s=e.dataset.key;switch(o){case"edit":this.editLSItem(s);break;case"copy":this.copyLog(s,"",!0);break;case"remove":this.removeLSItem(s);break;case"cancel":this.cancelEditLSItem(s);break;case"save":this.saveLSItem(s)}}),this.title.title="运行代码功能已被禁用",this.title.cursor="not-allowed",this.options.jsExecute&&(this.title.title="你可以点击标题以输入代码以执行",this.title.cursor="pointer",this.title.addEventListener("click",function(){let code=prompt("请输入要执行的代码:");if(null!=code&&code.trim())try{let result;result=eval(code),console.log(`${code}\n>`,result)}catch(t){console.error(`${code}\n> 执行失败:${t}`)}}.bind(window))),this.overlay.addEventListener("click",t=>{let e=t.target.closest(".json-page-btn");e&&this.changeJsonPage(parseInt(e.dataset.id),parseInt(e.dataset.page,10));let o=t.target.closest(".ls-json-page-btn");o&&this.changeLSJsonPage(decodeURIComponent(o.dataset.key),parseInt(o.dataset.page,10)),t.target===this.overlay&&(this.triggerGlobalHook("beforeClose"),this.overlay.classList.remove("active"),this.triggerGlobalHook("afterClose"))}),this.filterButtons.forEach(t=>{t.addEventListener("click",()=>{this.filterButtons.forEach(t=>t.classList.remove("active")),t.classList.add("active"),this.activeFilter=t.dataset.type,this.updateFilterCounts(),this.renderContent()})}),this.searchInput.addEventListener("input",(t=>e=>{clearTimeout(t),t=setTimeout(()=>{this.searchQuery=e.target.value.toLowerCase().trim(),this.renderContent()},300)})(0)),this.clearLogsBtn.addEventListener("click",()=>this.clearAllLogs()),this.tabButtons.forEach(t=>{t.addEventListener("click",()=>{this.tabButtons.forEach(t=>t.classList.remove("active")),t.classList.add("active"),this.currentTab=t.dataset.tab,this.renderContent()})}),this.addLSItemBtn.addEventListener("click",()=>this.addLSItem())}createBuiltinTabs(){[{id:"console",name:"控制台",icon:"fa fa-terminal"},{id:"system",name:"系统日志",icon:"fa fa-server"},{id:"localstorage",name:"本地存储",icon:"fa fa-database"}].forEach(t=>{let e=document.createElement("button");e.className="tab-btn",e.dataset.tab=t.id,e.title=t.name,e.innerHTML=`<i class="${t.icon}"></i>${t.name}`,"console"===t.id&&e.classList.add("active"),e.addEventListener("click",()=>{this.tabButtons=this.overlay.querySelectorAll(".tab-btn"),this.tabButtons.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.currentTab=t.id,this.renderContent()}),this.tabButtonsContainer.appendChild(e)})}createPluginTab(t){let e=document.createElement("button");e.className="tab-btn",e.dataset.tab=t.id?t.id:"newTab",tab.title=t.name?t.name:"新的插件",e.innerHTML=`<i class="${t.icon?t.icon:"fa fa-plug"}"></i>${t.name?t.name:"新的插件"}`,this.tabButtonsContainer.appendChild(e),e.addEventListener("click",()=>{this.tabButtons=this.overlay.querySelectorAll(".tab-btn"),this.tabButtons.forEach(t=>t.classList.remove("active")),e.classList.add("active"),this.currentTab=t.id,this.renderContent()});let o=document.createElement("div");o.id=`${t.id}View`,o.innerHTML="无插件视图",o.className="plug-view",o.style.display="none",this.contentArea.appendChild(o),this.pluginViewContainers[t.id]=o}createNotificationElement(){this.notification=document.createElement("div"),this.notification.id="notification",this.notification.className="notification",this.notification.textContent="已复制到剪贴板",document.documentElement.appendChild(this.notification)}createStyles(){let t=document.createElement("style");t.innerHTML='@import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css");*{margin:0;padding:0;box-sizing:border-box}.floating-console-btn{position:fixed;z-index:11000;touch-action:none;will-change:transform;padding:15px 25px;backdrop-filter:blur(5px);border-radius:5px;border:none;background:#007aff;color:white;font-size:1rem;cursor:move;display:flex;align-items:center;gap:10px;font-weight:500;box-shadow:0 8px 20px rgba(0,0,0,0.4);transition:all 0.3s ease;user-select:none}.floating-console-btn:active{transform:scale(0.98)}.floating-console-btn i{font-size:1.2rem}.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:99998;opacity:0;visibility:hidden;transition:all 0.4s ease;backdrop-filter:blur(5px)}.overlay.active{opacity:1;visibility:visible}.theme-dark{--console-bg:#1e1e1e;--header-bg:#252526;--text-color:#d4d4d4;--controls-bg:#2d2d2d;--border-color:rgba(255,255,255,0.05);--log-bg:#191919;--log-border-light:3px solid;--filter-active:#4a4ae6;--search-bg:#3e3e42;--json-bg:rgba(40,40,40,0.7);--json-key:#6aaeff;--json-string:#98c379;--json-number:#d19a66;--json-boolean:#56b6c2;--json-null:#be5046;--action-bg:rgba(106,174,255,0.3);--action-hover:rgba(106,174,255,0.5);--log-icon-info:#4a4ae6;--log-bg-warn:rgba(255,193,7,0.1);--log-icon-warn:#d9a40d;--log-icon-error:#ff3b30;--clear-btn-color:#ff6b6b;--clear-btn-hover:#ff5252;--tab-bg:#333;--tab-active:#444;--tab-color:#ddd}.theme-light{--console-bg:#ffffff;--header-bg:#f0f0f0;--text-color:#333;--controls-bg:#e0e0e0;--border-color:rgba(0,0,0,0.1);--log-bg:#f3f3f3;--log-border-light:3px solid;--filter-active:#4a4ae6;--search-bg:#f0f0f0;--json-bg:rgba(240,240,240,0.9);--json-key:#1e6bb8;--json-string:#22863a;--json-number:#d73a49;--json-boolean:#005cc5;--json-null:#6f42c1;--action-bg:rgba(30,107,184,0.1);--action-hover:rgba(30,107,184,0.2);--log-bg-warn:rgba(255,243,205,0.75);--log-icon-info:#1e6bb8;--log-icon-warn:#e36209;--log-icon-error:#d73a49;--clear-btn-color:#ff5252;--clear-btn-hover:#ff3b30;--tab-bg:#e5e5e5;--tab-active:#ddd;--tab-color:#333}.console-container{background:var(--console-bg);overflow:hidden;display:flex;flex-direction:column;box-shadow:0 15px 35px rgba(0,0,0,0.3);position:fixed;z-index:99999;left:0;bottom:0;width:100%;height:90vh;transform:translateY(100%);transition:transform 0.4s cubic-bezier(.25,.8,.25,1);}.overlay.active .console-container{transform:translateY(0)}.console-header{display:flex;justify-content:space-between;align-items:center;padding:15px 25px;background:var(--header-bg);border-bottom:1px solid var(--border-color);position:relative}.console-title{font-size:1.3rem;color:var(--text-color);gap:10px;display:flex;align-items:center}.push-btn{border:none;background:var(--filter-active);color:white;padding:10px;border-radius:5px}.close-btn{background:transparent;border:none;color:var(--text-color);font-size:1.5rem;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:5px;transition:all 0.3s}.close-btn:hover{background:rgba(255,100,100,0.2);color:#ff6464;transform:scale(1.1)}.clear-all-btn{position:absolute;top:50%;right:50px;transform:translateY(-50%);background:transparent;border:none;color:var(--clear-btn-color);font-size:1.5rem;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:5px;transition:all 0.3s;margin-left:0}.clear-all-btn:hover{background:rgba(255,100,100,0.2);color:var(--clear-btn-hover)}.tabs{display:block;white-space:nowrap;overflow-x:auto;background:var(--tab-bg);padding:5px 10px 0;border-bottom:1px solid var(--border-color)}.tab-btn{padding:12px 20px;background:transparent;border-radius:5px 5px 0 0;border:none;color:var(--tab-color);font-size:1rem;cursor:pointer;position:relative;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}.tab-btn.active{color:var(--text-color);font-weight:600}.tab-btn.active::after{content:\'\';position:absolute;bottom:0;left:0;width:100%;height:2px;border-radius:3px;background:var(--filter-active)}.tab-btn:hover:not(.active){background:rgba(255,255,255,0.05)}.controls{display:flex;padding:15px 20px;background:var(--controls-bg);gap:15px;flex-wrap:wrap;border-bottom:1px solid var(--border-color);align-items:center}.filters{display:flex;flex-wrap:nowrap;margin-left:-5px}.filter-btn>.fa{margin-right:5px;margin-top:2px}.filter-btn{position:relative;padding:10px;border:none;background:none;color:var(--text-color);cursor:pointer;font-size:0.85rem;transition:all 0.2s;display:flex;width:100%;white-space:nowrap}.filter-btn.active::after{content:"";position:absolute;width:90%;transition:all 0.3s ease;left:3px;height:2px;top:90%;border-radius:3px;background:var(--filter-active);color:white}.search-box{display:flex;flex-grow:1;max-width:400px}.search-box input{padding:10px 15px;border-radius:5px;border:none;background:var(--search-bg);color:var(--text-color);width:100%;transition:all 0.3s ease;font-size:0.95rem;border:1px solid var(--border-color)}.search-box input:focus{outline:none;border-color:#4a4ae6}.console-content{flex:1;overflow:hidden;display:flex;flex-direction:column}.console-output,.localstorage-view,.system-logs{flex:1;overflow-y:auto;padding:20px;font-family:monospace;font-size:0.95rem}.log-item{padding:10px 15px;margin-bottom:10px;display:flex;align-items:flex-start;border-left:var(--log-border-light) #4a4ae6;background:var(--log-bg);border-radius:5px}.log-item.log{border-left-color:#4a4ae6}.log-item.info{border-left-color:var(--log-icon-info)}.log-item.warn{border-left-color:var(--log-icon-warn);background:var(--log-bg-warn)}.log-item.error{border-left-color:var(--log-icon-error);background:rgba(255,59,48,0.15)}.log-count{background:#4a4ae6;color:white;border-radius:5px;min-width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:0.85rem;margin-right:10px;margin-top:-3px;padding:10px}.log-icon{margin-right:12px;font-size:1rem;min-width:20px;color:var(--text-color)}.log-content{width:100%;max-height:500px;overflow-y:auto;flex-grow:1;word-break:break-word;line-height:1.5;color:var(--text-color)}.timestamp{color:#707070;font-size:0.8rem;margin-left:10px;white-space:nowrap}.normal-timestamp{margin-top:-30px !important}.hasobj-tsp{margin-left:115px !important}.json-preview{font-family:monospace;padding:10px;margin-top:5px;background:var(--json-bg);border-radius:5px;white-space:pre !important;word-break:break-all ！important;max-height:400px;overflow:auto}.json-page-btn,.ls-json-page-btn{border:none}.ls-json-preview{border-radius:5px;margin-top:-5px}.json-number{color:var(--json-number)}.json-boolean{color:var(--json-boolean)}.json-key{color:var(--json-key)}.json-null{color:var(--json-null)}.json-string{color:var(--json-string)}.json-cmt{color:#707070}.log-actions{margin-top:8px;display:flex;gap:10px;font-size:0.85rem}.log-action{color:var(--json-key);cursor:pointer;padding:5px 10px;background:var(--action-bg);transition:all 0.2s;display:inline-flex;align-items:center;gap:5px;border-radius:5px}.log-action:hover{background:var(--action-hover)}.log-action.copy-btn{background:var(--action-bg)}.log-action.copy-btn:hover{background:var(--action-hover)}.error-stack{font-family:monospace;padding:10px;margin-top:10px;background:rgba(255,59,48,0.1);border-radius:5px;white-space:pre-wrap;word-break:break-all;color:#ff8a80;font-size:0.85rem}.object-preview{font-family:monospace;padding:10px;margin-top:5px;background:var(--json-bg);color:var(--json-number);border-radius:5px}.function-preview{font-family:monospace;padding:10px;margin-top:5px;background:var(--json-bg);color:var(--json-boolean);border-radius:5px;white-space:pre;word-break:break-all;overflow-x:auto}.ls-header{padding:15px 0;display:flex;justify-content:flex-end}.ls-item{background:var(--log-bg);padding:15px;margin-bottom:15px;border-radius:8px}.ls-key-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;border-bottom:1px solid var(--border-color);padding-bottom:10px}.ls-key{color:var(--json-key);font-size:1.1rem;max-width:60%;overflow-x:auto;white-space:nowrap}.ls-actions{display:flex;gap:8px}.ls-action-btn{background:var(--action-bg);border:none;color:var(--text-color);padding:5px 10px;border-radius:5px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:5px}.ls-action-btn:hover{background:var(--action-hover)}.ls-value{white-space:normal;word-break:break-all;padding:10px;background:var(--json-bg);border-radius:5px;font-family:monospace;max-height:200px;overflow-y:auto;color:var(--text-color)}.ls-edit{display:flex;flex-direction:column;gap:10px;margin-top:10px;display:none}.ls-edit textarea{width:100%;min-height:100px;padding:10px;background:var(--search-bg);border:1px solid var(--border-color);border-radius:5px;color:var(--text-color);font-family:monospace;resize:vertical;outline:none;transition:all 0.3s ease}.ls-edit textarea:focus{border-color:#4a4ae6}.ls-key-edit{display:none;width:60%;padding:6px 10px;border:1px solid var(--border-color);border-radius:5px;background:var(--search-bg);font-size:1.1rem;outline:none;transition:border .2s;color:var(--json-key);font-family:monospace;}.ls-key-edit:focus{border-color:#4a4ae6;}.ls-item.editing .ls-key{display:none;}.ls-item.editing .ls-key-edit{display:block;}.ls-edit-actions{display:flex;gap:10px;justify-content:flex-end}.ls-value-type{font-size:0.8rem;opacity:0.7;margin-top:5px;color:var(--text-color)}.system-log-content{width:100%;max-height:300px;overflow-y:auto;font-family:monospace;white-space:pre-wrap;word-break:break-word;color:var(--text-color)}.system-log-date{font-size:0.8rem;color:#707070;margin-top:3px}@media(orientation:landscape){.timestamp{display:none}}@media(max-width:768px){.controls{flex-direction:column;align-items:flex-start}.search-box{max-width:100%;width:100%}.log-item{flex-wrap:wrap}.timestamp{width:100%;margin-left:40px;margin-top:5px}.log-actions{flex-wrap:wrap}.floating-console-btn{padding:12px 20px;font-size:0.9rem;right:20px;bottom:20px}.clear-all-btn{right:60px}.tab-btn{padding:8px 12px;font-size:0.9rem}}.nolog{text-align:center;font-size:20px;color:var(--text-color);padding:40px 0}.nolog>.fa{margin-right:5px}.notification{position:fixed;top:20px;right:20px;padding:12px 20px;background:#4CAF50;color:white;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:99999;transform:translateX(120%);transition:transform 0.3s ease}.notification.show{transform:translateX(0)}.notification.warning{background:#ff9800}',t.setAttribute("tcstyle",""),document.head.append(t)}showNotification(t,e=""){this.notification.textContent=t,this.notification.className="notification","warning"===e&&this.notification.classList.add("warning"),this.notification.classList.add("show"),setTimeout(()=>{this.notification.classList.remove("show")},3e3)}captureConsoleLogs(){this.originalConsole={log:console.log,info:console.info,warn:console.warn,error:console.error},console.log=(...t)=>this.captureConsole("log",...t),console.info=(...t)=>this.captureConsole("info",...t),console.warn=(...t)=>this.captureConsole("warn",...t),console.error=(...t)=>this.captureConsole("error",...t),console.debug=(...t)=>this.captureConsole("log",...t),console.time=(t="time")=>{t=String(t);let e=performance.now();this.timerMap.has(t)&&clearTimeout(this.timerMap.get(t).timeoutId);let o=setTimeout(()=>{if(!this.timerMap.has(t))return;let{start:e}=this.timerMap.get(t);this.timerMap.delete(t),this.info(`[time] "${t}"用时: ${(performance.now()-e).toFixed(1)}ms(已超时)`)},3e5);this.timerMap.set(t,{start:e,timeoutId:o})},console.timeEnd=(t="time")=>{t=String(t);let e=this.timerMap.get(t);if(!e)return void this.error(`[timeEnd] 标签"${t}"不存在`);e.timeoutId&&clearTimeout(e.timeoutId);let o=performance.now()-e.start;this.timerMap.delete(t),this.info(`[time] "${t}"用时: ${o.toFixed(1)}ms`)},console.count=(t="count")=>{t=String(t);let e=(this.countMap.get(t)||0)+1;this.countMap.set(t,e),this.info(`[count] 标签"${t}"被调用了${e}次`)},console.countReset=(t="count")=>{t=String(t),this.countMap.has(t)?this.countMap.delete(t):this.error(`[countReset] 标签"${t}"不存在`)},console.assert=(t,...e)=>{t||this.error("[assertion failed] ",...e)},console.trace=(...t)=>{let e=(new Error).stack.split("\n").slice(2).join("\n");this.warn("[trace] ",...t,"\n"+e)},console.group=t=>this.captureConsole("log",`[Group ${t}]`),console.groupEnd=()=>this.captureConsole("log","[GroupEnd]"),console.clear=()=>this.clearAllLogs(!0)}safeStringify(t,e=2){let o=new WeakSet;return JSON.stringify(t,function(t,e){if("object"==typeof e&&null!==e){if(o.has(e))return"[循环引用]";if(o.add(e),!Array.isArray(e)&&e.constructor===Object){let t=Object.keys(e).sort((t,e)=>t.localeCompare(e,void 0,{numeric:!0,sensitivity:"base"})),o={};for(let s of t)o[s]=e[s];return o}return e instanceof RegExp?e.toString():e instanceof Error?{"名字":e.name,"信息":e.message,"堆栈":e.stack}:e instanceof Date?e.toISOString():e instanceof HTMLElement?`<${e.tagName.toLowerCase()}>${e.tagName.toLowerCase()}元素</${e.tagName.toLowerCase()}>`:e}return e instanceof Error?{"名字":e.name,"信息":e.message,"堆栈":e.stack}:"function"==typeof e?e.toString().replace(/function /,"").replace(/ \[ native code \]/,"").replace(/^\(\)/,"function()"):e instanceof Date?e.toISOString():e instanceof HTMLElement?`<${e.tagName.toLowerCase()}>${e.tagName.toLowerCase()}元素</${e.tagName.toLowerCase()}>`:e},e)}formatArgsForPlainText(t){return Array.from(t).map(t=>{if("object"==typeof t&&null!==t)try{return this.safeStringify(t)}catch{return"[无法序列化的对象]"}return String(t)}).join(" ")}captureConsole(t,...e){this.triggerGlobalHook("beforeLog",t,...e);let o=new Date,s=e.map(t=>{if("object"==typeof t&&null!==t)try{if(t instanceof Date)return`日期:${t.getTime()}`;if(t instanceof RegExp)return`正则表达式:${t.toString()}`;if(t instanceof Error)return`错误:${t.message}`;let e=Object.entries(t).reduce((t,[e,o])=>{if("then"===e&&"function"==typeof o)return t;if("object"==typeof o&&null!==o)try{t[e]=JSON.stringify(o)}catch{t[e]="NestedObject"}else t[e]=o;return t},{});return`[Object]:${JSON.stringify(e)}`}catch{return`无法序列化:${Math.random().toString(36).substring(2,10)}`}return`${typeof t}:${String(t)}`}).join("|"),i=e.length>0&&"string"==typeof e[0]&&e[0].startsWith("[system]");if(this.lastLog&&this.lastLog.type===t&&this.lastLog.contentSign===s){this.lastLog.args=[...e],this.lastLog.timestamp=new Date,this.lastLog.count++;let o=this.systemLogs.find(t=>t.id===this.lastLog.id);if(e.some(t=>"object"==typeof t&&null!==t)){let t=this.safeStringify(e[0]);this.jsonPageIndex.has(t)||(this.jsonPageIndex.set(t,0),this.getPagedJson(e[0],0))}if(!o&&this.lastLog.isSystem&&(this.systemLogs.push(this.lastLog),o=this.lastLog),i){o.args=[...e],o.timestamp=new Date,o.count=this.lastLog.count;let t=document.getElementById(`sys-log-item-${o.id}`);if(t){let e=t.querySelector(".log-count");e||(e=document.createElement("div"),e.className="log-count",t.insertBefore(e,t.firstChild)),e.textContent=this.lastLog.count}}let s=document.getElementById(`log-item-${this.lastLog.id}`);if(s){let t=s.querySelector(".log-count");t||(t=document.createElement("div"),t.className="log-count",s.insertBefore(t,s.firstChild)),t.textContent=this.lastLog.count}return this.originalConsole[t].apply(console,e),void this.updateFilterCounts()}{let n={id:this.logs.length,type:t,args:[...e],content:this.formatArgsForPlainText(e),timestamp:o,count:1,expandedJson:!1,contentSign:s,hasObject:e.some(t=>"object"==typeof t&&null!==t||"function"==typeof t&&!/^class\s/.test(t.toString())),isError:"error"===t||e.some(t=>t instanceof Error),isSystem:i};if(i){let t={...n};t.id=this.systemLogs.length,this.systemLogs.push(t)}this.logs.push(n),this.lastLog=n,this.triggerGlobalHook("afterLog",n)}this.originalConsole[t].apply(console,e),this.overlay?.classList.contains("active")&&("console"===this.currentTab?(this.updateFilterCounts(),this.renderLogList(this.logs.filter(t=>!t.isSystem),!1)):"system"===this.currentTab&&i&&(this.updateFilterCounts(),this.renderLogList(this.systemLogs,!0))),[this.logs,this.systemLogs].forEach(t=>t.length>this.maxLog&&t.splice(0,t.length-this.maxLog))}formatArgs(t,e){return Array.from(t).map(t=>{if("function"==typeof t)return`<div class="function-preview">${String(t)}</div>`;if(t instanceof Error)return`<div class="error-stack"><strong>${t.name}:</strong> ${t.message}<div>${t.stack||"无堆栈信息"}</div></div>`;if(t instanceof HTMLElement)return`<div class="object-preview">&lt;${t.tagName.toLowerCase()}&gt;${t.tagName.toLowerCase()}元素&lt;/${t.tagName.toLowerCase()}&gt;</div>`;if("object"==typeof t&&null!==t){let o="log-"+e,s=this.jsonPageIndex.get(o)||0,i=this.getPagedJson(t,s),n=this.getJsonKeys(t).length,a=Math.ceil(n/this.jsonPageSize),r=this.safeStringify(i,2).replace(/\\t/g,"").replace(/\\n/g,"\n").replace(/</g,"&lt;").replace(/>/g,"&gt;"),l='<div class="json-preview">'+this.highlightJson(r)+"</div>";return a>1&&(encodeURIComponent(o),l+=`<div style="margin-top:10px;display:flex;justify-content:center;gap:10px;align-items:center;"><button class="log-action json-page-btn" data-id="${e}" title="上一页" data-page="${Math.max(s-1,0)}"><i class="fa fa-angle-left"></i>上一页</button><span style="color:#707070">第 ${s+1}/${a} 页</span><button class="log-action json-page-btn" data-id="${e}" title="下一页" data-page="${Math.min(s+1,a-1)}">下一页<i class="fa fa-angle-right"></i></button></div>`),l}return String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\\n/g,"<br>")}).join(" ")}highlightJson(t){return t?t.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(\.\d*)?([eE][+-]?\d+)?|\{|\}|\[|\]|\.|,)/g,t=>{let e="json-number";return/^"/.test(t)?(e=/:$/.test(t)?"json-key":"json-string",/^"[^"]*\(\)"$/.test(t)&&(e="json-boolean",t=(t="ƒ "+t.replace(/"/g,"")).replace(/(\(\))/g,"<span class='json-cmt'>$&</span>"))):/true|false/.test(t)?e="json-boolean":/null/.test(t)?e="json-null":/(?<!\d)\.(?!\d)|[\{\}\[\],]/.test(t)&&(e="json-cmt"),'<span class="'+e+'">'+t+"</span>"}):""}getJsonKeys(t){return Array.isArray(t)?t.map((t,e)=>e):"object"==typeof t&&null!==t?Object.keys(t):[]}getPagedJson(t,e){let o=this.safeStringify(t);if(!this.jsonPageCache.has(o)){let e=this.getJsonKeys(t),s=[];for(let t=0;t<e.length;t+=this.jsonPageSize)s.push(e.slice(t,t+this.jsonPageSize));this.jsonPageCache.set(o,s)}let s=this.jsonPageCache.get(o)[e]||[];if(Array.isArray(t))return s.map(e=>t[e]);{let e={};return s.forEach(o=>e[o]=t[o]),e}}changeJsonPage(t,e){let o=`log-${t}`;this.jsonPageIndex.set(o,e);let s=[...this.logs,...this.systemLogs].find(e=>e.id===t);if(s){let e=this.systemLogs.includes(s);this.updateLogItem(t,e)}}toggleExpandJson(t){let e="system"===this.currentTab,o=(e?this.systemLogs:this.logs).find(e=>e.id===t);if(!o)return;let s=!o.expandedJson;if(o.expandedJson=s,s){let t=o.args[0];if("object"==typeof t&&null!==t){let e=this.safeStringify(t);this.jsonPageIndex.set(e,0)}}this.updateLogItem(t,e)}updateLogItem(t,e=!1){let o=(e?this.systemLogs:this.logs).find(e=>e.id===t);if(!o)return;let s=document.getElementById(`${e?"sys-":""}log-item-${t}`);if(!s)return;let i={info:"fa fa-info-circle",warn:"fa fa-exclamation-triangle",error:"fa fa-times-circle",log:"fa fa-info"}[o.type]||"fa fa-info",n=o.timestamp.toLocaleTimeString(),a=o.timestamp.toLocaleDateString(),r=o.expandedJson?this.formatArgs(o.args,o.id).replace(/^\[system](?! )|^\[system] /,""):o.args.map(t=>"function"==typeof t?/^class\s/.test(t.toString())?`<span class='json-boolean'>[Class ${t.name}]</span>`:`<span class='json-boolean'>ƒ ${t.name}</span><span class='json-cmt'>()</span>`:"object"==typeof t&&null!==t?t instanceof Error?`<strong>${t.name}:</strong>${t.message}`:t instanceof HTMLElement?`<span class='json-number'>&lt;${t.tagName.toLowerCase()}&gt;</span>`:'<span class="json-cmt">{Object}</span>':String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")).join(" ").replace(/^\[system](?! )|^\[system] /,""),l=[];o.hasObject&&l.push(`<div class="log-action" title="${o.expandedJson?"收起":"展开"}" onclick="thinConsole.tC.toggleExpandJson(${t})"><i class="fa ${o.expandedJson?"fa-chevron-up":"fa-chevron-down"}"></i>${o.expandedJson?"收起":"展开"}</div>`),l.push(`<div class="log-action copy-btn" title="复制" onclick="thinConsole.tC.copyLog(${t},${e})"><i class="fa fa-copy"></i></div>`),s.innerHTML=`${o.count>1?`<div class="log-count">${o.count}</div>`:""}<div class="log-icon"><i class="${i}"></i></div><div class="log-content">${r}<div class="log-actions">${l.join("")}<div class="timestamp normal-timestamp ${o.hasObject?"hasobj-tsp":""}">${a} ${n}</div></div></div>`}updateFilterCounts(){if(!this.filterButtons)return;let t=[];"console"===this.currentTab?t=this.logs.filter(t=>!t.isSystem):"system"===this.currentTab&&(t=this.systemLogs);let e=(t,e)=>t.reduce((t,o)=>o.type===e?t+(o.count||1):t,0),o={all:t.reduce((t,e)=>t+(e.count||1),0),log:e(t,"log"),info:e(t,"info"),warn:e(t,"warn"),error:e(t,"error")};this.filterButtons.forEach(t=>{let e=t.dataset.type,s=o[e]||0;if(t.dataset.originalHtml||(t.dataset.originalHtml=t.innerHTML),t.classList.contains("active")){let e=s>99?"99+":s;t.innerHTML=`${t.dataset.originalHtml} (${e})`}else t.innerHTML=t.dataset.originalHtml})}renderContent(){if(this.triggerGlobalHook("beforeRender",this.currentTab),this.consoleOutput.style.display="none",this.localstorageView.style.display="none",this.systemLogsEl.style.display="none",this.clearLogsBtn.style.display="none",Object.values(this.pluginViewContainers).forEach(t=>{t.style.display="none"}),this.consoleControls.style.display="flex",["console","system","localstorage"].includes(this.currentTab))switch(this.clearLogsBtn.style.display="block",this.currentTab){case"console":this.consoleOutput.style.display="block",this.renderLogList(this.logs.filter(t=>!t.isSystem),!1),this.updateFilterCounts();break;case"localstorage":this.localstorageView.style.display="block",this.consoleControls.style.display="none",this.renderLocalStorage();break;case"system":this.systemLogsEl.style.display="block",this.renderLogList(this.systemLogs,!0),this.updateFilterCounts()}else if(this.pluginViewContainers[this.currentTab]){let t=Object.keys(this.pluginTabs).find(t=>this.pluginTabs[t].id===this.currentTab);if(this.consoleControls.style.display="none",t){let e=this.pluginViewContainers[this.currentTab];e.style.display="block";let o=this.plugins[t];o&&"function"==typeof o.onShow&&o.onShow(),o&&"function"==typeof o.render&&o.render(e)}}this.triggerGlobalHook("afterRender",this.currentTab)}renderLogList(t,e){let o=e?this.systemLogsEl:this.consoleOutput,s=e?"系统日志":"日志记录";if(!o)return;if(0===t.length)return void(o.innerHTML=`<div class="nolog"><i class="fa fa-${e?"server":"info-circle"}"></i>无${s}</div>`);let i=[...t];if(this.activeFilter&&"all"!==this.activeFilter&&(i=i.filter(t=>t.type===this.activeFilter)),this.searchQuery){let t,e=this.searchQuery.trim(),o=!1;if(e.startsWith("/")&&e.endsWith("/"))try{let s=e.slice(1,-1),i=s.lastIndexOf("/"),n="";i>0?(n=s.slice(i+1),t=new RegExp(s.slice(0,i),n)):t=new RegExp(s),o=!0}catch{this.showNotification("无效的正则表达式:"+e),o=!1}let s=o?e:e.toLowerCase();i=i.filter(e=>e.args.some(e=>{let i;return i=e instanceof Error?"[error]":null==e?"null":void 0===e?"undefined":"object"==typeof e?'<span class="json-cmt">{Object}</span>':String(e),o&&t?t.test(i):i.toLowerCase().includes(s.toLowerCase())}))}if(0===i.length)return void(o.innerHTML=`<div class="nolog"><i class="fa fa-search"></i>无匹配的${s}</div>`);let n=i.map(t=>{let o;switch(t.type){case"info":o="fa fa-info-circle";break;case"warn":o="fa fa-exclamation-triangle";break;case"error":o="fa fa-times-circle";break;default:o="fa fa-info"}let s=t.timestamp.toLocaleTimeString(),i=t.timestamp.toLocaleDateString();return e?`<div class="log-item ${t.type}" id="sys-log-item-${t.id}">${t.count>1?`<div class="log-count">${t.count}</div>`:""}<div class="log-icon"><i style="margin-right:5px" class="${o}"></i>${t.type}</div><div class="system-log-date">${i} ${s}</div><div class="system-log-content">${t.expandedJson?this.formatArgs(t.args,t.id).replace(/^\[system](?! )|^\[system] /,""):t.args.map(e=>"function"==typeof e?/^class\s/.test(e.toString())?`<span class='json-boolean'>[Class ${e.name}]</span>`:`<span class='json-boolean'>ƒ ${e.name}</span><span class='json-cmt'>()</span>`:"object"!=typeof e||t.expandedJson?String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>"):e instanceof Error?`<strong>${e.name}:</strong>${e.message}`:e instanceof HTMLElement?`<span class="json-number">&lt;${e.tagName.toLowerCase()}&gt;</span>`:'<span class="json-cmt">{Object}</span>').join(" ").replace(/^\[system](?! )|^\[system] /,"")}</div>${t.hasObject?`<div class="log-actions"><div class="log-action" title="${t.expandedJson?"收起":"展开"}" onclick="thinConsole.tC.toggleExpandJson(${t.id})"><i class="fa ${t.expandedJson?"fa-chevron-up":"fa-chevron-down"}"></i>${t.expandedJson?"收起":"展开"}</div><div class="log-action copy-btn" title="复制" onclick="thinConsole.tC.copyLog(${t.id},true)"><i class="fa fa-copy"></i></div></div>`:`<div class="log-actions"><div class="log-action copy-btn" title="复制" onclick="thinConsole.tC.copyLog(${t.id},true)"><i class="fa fa-copy"></i></div></div>`}</div>`:`<div class="log-item ${t.type}" id="log-item-${t.id}">${t.count>1?`<div class="log-count">${t.count}</div>`:""}<div class="log-icon"><i class="${o}"></i></div><div class="log-content">${t.expandedJson?this.formatArgs(t.args,t.id):t.args.map(e=>"function"==typeof e?/^class\s/.test(e.toString())?`<span class='json-boolean'>[Class ${e.name}]</span>`:`<span class='json-boolean'>ƒ ${e.name}</span><span class='json-cmt'>()</span>`:"object"!=typeof e||t.expandedJson?String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>"):e instanceof Error?`<strong>${e.name}:</strong>${e.message}`:e instanceof HTMLElement?`<span class="json-number">&lt;${e.tagName.toLowerCase()}&gt;</span>`:'<span class="json-cmt">{Object}</span>').join(" ")}<div class="log-actions">${t.hasObject?`<div class="log-action" title="${t.expandedJson?"收起":"展开"}" onclick="thinConsole.tC.toggleExpandJson(${t.id})"><i class="fa ${t.expandedJson?"fa-chevron-up":"fa-chevron-down"}"></i>${t.expandedJson?"收起":"展开"}</div><div class="log-action copy-btn" title="复制" onclick="thinConsole.tC.copyLog(${t.id},false)"><i class="fa fa-copy"></i></div>`:`<div class="log-action copy-btn" title="复制" onclick="thinConsole.tC.copyLog(${t.id},false)"><i class="fa fa-copy"></i></div>`}<div class="timestamp normal-timestamp${t.hasObject?" hasobj-tsp":""}">${i} ${s}</div></div></div></div>`}).join("");o.innerHTML=n,Number(o.dataset.bottom||0)<50&&(o.scrollTop=o.scrollHeight),[...o.querySelectorAll(".log-item")].slice(0,-this.maxLog).forEach(t=>t.remove())}copyLog(t,e=!1,o=!1){if(o){let e=localStorage.getItem(t);e&&navigator.clipboard.writeText(e).then(()=>this.showNotification(`已复制"${t}"的值`)).catch(t=>console.error("复制失败:",t))}let s=(e?this.systemLogs:this.logs).find(e=>e.id===t);if(!s)return;let i="";s.count>1&&(i+=`[重复${s.count}次]`),s.args.forEach((t,e)=>{if(e>0&&(i+=" "),"object"==typeof t&&null!==t)try{i+=this.safeStringify(t,2)}catch{i+="{object}"}else i+=String(t)}),e&&(i=i.replace(/\[system](?! )|\[system] /,"")),navigator.clipboard.writeText(i).then(()=>this.showNotification("已复制到剪贴板")).catch(t=>console.error("复制失败:",t))}clearAllLogs(t=!1){if(this.triggerGlobalHook("beforeClear"),t)return this.logs=[],this.systemLogs=[],this.lastLog=null,this.renderContent(),void this.updateFilterCounts();if("localstorage"==this.currentTab)return void(confirm("确定要清除所有本地存储吗？此操作不可撤销。")&&(localStorage.clear(),this.renderLocalStorage()));let e="system"==this.currentTab;confirm(`确定要清除所有${e?"系统":"普通"}日志吗？此操作不可撤销。`)&&(e?this.systemLogs=[]:this.logs=[],this.lastLog=null,this.renderContent(),this.updateFilterCounts(),this.showNotification(`所有${e?"系统":"普通"}日志已清除`,"warning"),this.triggerGlobalHook("afterClear"))}renderLSJsonPage(t,e,o){let s=this.getJsonKeys(e).length,i=Math.ceil(s/this.lsJsonPageSize);this.lsJsonPageIndex.set(t,o);let n=this.getJsonKeys(e),a=o*this.lsJsonPageSize,r=Math.min(a+this.lsJsonPageSize,n.length),l=n.slice(a,r),c=Array.isArray(e)?l.map(t=>e[t]):Object.fromEntries(l.map(t=>[t,e[t]])),d=this.safeStringify(c,2).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\\n/g,""),h='<div class="json-preview ls-json-preview">'+this.highlightJson(d);if(i>1){let e=encodeURIComponent(t);h+=`<div style="display:flex;justify-content:center;gap:10px;margin-top:8px;"><button class="log-action ls-json-page-btn" data-key="${e}" title="上一页" data-page="${Math.max(o-1,0)}"><i class="fa fa-angle-left"></i>上一页</button><span style="color:#707070;margin-top:3px">第 ${o+1}/${i} 页</span><button class="log-action ls-json-page-btn" data-key="${e}" title="下一页" data-page="${Math.min(o+1,i-1)}">下一页<i class="fa fa-angle-right"></i></button></div>`}h+="</div>",this.findLSItem(t).querySelector(".ls-value").style.background="inherit";let g=this.findLSItem(t).querySelector(".ls-json-pages");g&&(g.innerHTML=h)}changeLSJsonPage(t,e){let o=decodeURIComponent(t),s=localStorage.getItem(o);if(s)try{let t=JSON.parse(s);this.renderLSJsonPage(o,t,e)}catch(t){console.error("解析失败:",t)}}renderLocalStorage(){if(this.lsItems.innerHTML="",this.isLSEmpty())return void(this.lsItems.innerHTML='<div class="nolog"><i class="fa fa-database"></i>无本地存储</div>');let t=[];for(let e=0;e<localStorage.length;e++)t.push(localStorage.key(e));t.sort((t,e)=>t.localeCompare(e,void 0,{numeric:!0,sensitivity:"base"}));for(let e of t){let t=localStorage.getItem(e);this.addLSItemToDOM(e,t)}}addLSItemToDOM(t,e){let o=this.escapeHtml(t),s=document.createElement("div");s.className="ls-item",s.dataset.key=o;let{displayValue:i,valueType:n,isJSON:a}=this.parseAndTypeCheck(e),r=a?this.highlightJson(i):this.escapeHtml(i),l="";if(a){let s=JSON.parse(e);this.getJsonKeys(s).length>this.lsJsonPageSize?(l=`<div class="ls-value"><div class="ls-json-pages" data-key="${o}"></div></div>`,this.lsJsonPageIndex.set(t,0),setTimeout(()=>this.renderLSJsonPage(t,s,0))):l=`<div class="ls-value"><pre>${r}</pre></div>`}else l=`<div class="ls-value" title="${i}"><span class="json-${n}">${"string"===n?'"':""}${r}${"string"===n?'"':""}</span></div>`;s.innerHTML=`<div class="ls-key-row"><input class="ls-key-edit" value="${o}" data-old-key="${o}"/><div class="ls-key" title="${o}">${o}</div><div class="ls-actions"><button class="ls-action-btn" data-action="edit" data-key="${o}" title="编辑"><i class="fa fa-edit"></i></button><button class="ls-action-btn" data-action="copy" data-key="${o}" title="复制"><i class="fa fa-copy"></i></button><button class="ls-action-btn" data-action="remove" data-key="${o}" title="删除"><i class="fa fa-trash"></i></button></div></div>${l}<div class="ls-value-type" title="${n}">类型:${n}</div><div class="ls-edit" style="display:none"><textarea class="ls-edit-input">${this.escapeHtml(e)}</textarea><div class="ls-edit-actions"><button class="ls-action-btn" data-action="cancel" title="取消" data-key="${o}">取消</button><button class="ls-action-btn" data-action="save" title="保存" data-key="${o}">保存</button></div></div>`,this.lsItems.appendChild(s);let c=this.lsItems.querySelector(".nolog");c&&(c.style.display=this.isLSEmpty()?"block":"none")}parseAndTypeCheck(t){try{let e=JSON.parse(t);return"object"==typeof e&&null!==e?{displayValue:this.safeStringify(e,2).replace(/</g,"&lt;").replace(/>/g,"&gt;"),valueType:Array.isArray(e)?"array":"object",isJSON:!0}:null==e?{displayValue:null,valueType:null,isJSON:!1}:{displayValue:t,valueType:typeof e,isJSON:!1}}catch{return{displayValue:t,valueType:"string",isJSON:!1}}}isLSEmpty(){return!Array.from({length:localStorage.length},(t,e)=>localStorage.key(e)).some(t=>(t||"").trim())}escapeHtml(t){return String(t).replace(/</g,"&lt;").replace(/>/g,"&gt;")}addLSItem(){let t=(prompt("请输入键名：")||"").trim();if(!t)return;if(null!==localStorage.getItem(t))return void alert(`键名"${t}"已存在！`);let e,o=prompt(`请输入"${t}"的值：`);try{let t=this.fixKeysOnly(o),s=JSON.parse(t);e=JSON.stringify(s)}catch{e=o}localStorage.setItem(t,e),this.addLSItemToDOM(t,e),this.showNotification(`已添加键"${t}"`)}editLSItem(t){this.lsItems.querySelectorAll(".ls-item").forEach(t=>{t.classList.remove("editing"),t.querySelector(".ls-value").style.display="block",t.querySelector(".ls-edit").style.display="none";let e=t.querySelector(".ls-value-type");e&&(e.style.display="block")});let e=this.findLSItem(t);if(!e)return;e.classList.add("editing"),e.querySelector(".ls-value").style.display="none",e.querySelector(".ls-edit").style.display="block";let o=e.querySelector(".ls-value-type");o&&(o.style.display="none");let s=e.querySelector(".ls-edit-input");s&&s.focus()}saveLSItem(t){let e=this.findLSItem(t);if(!e)return;let o=e.querySelector(".ls-key-edit").value.trim();if(!o)return void this.showNotification("键名不能为空","warning");let s,i=e.querySelector(".ls-key-edit").dataset.oldKey,n=this.fixKeysOnly(e.querySelector(".ls-edit-input").value);try{s=JSON.stringify(JSON.parse(n))}catch{s=n}if(o===i)return localStorage.setItem(i,s),this.updateLSItemView(i),this.cancelEditLSItem(i),void this.showNotification(`已保存键"${i}"`);null===localStorage.getItem(o)?(localStorage.removeItem(i),localStorage.setItem(o,s),e.querySelector(".ls-key-edit").dataset.oldKey=o,e.dataset.key=o,this.updateLSItemView(o),this.cancelEditLSItem(o),this.showNotification(`已保存键"${o}"`)):this.showNotification(`键名"${o}"已存在！`,"warning")}fixKeysOnly(t){try{return JSON.parse(t),t}catch{return t.replace(/([{,])\s*([a-zA-Z_]\w*)\s*:/g,'$1"$2":').replace(/(":)\s*(?!true|false|null|\d+(\.\d+)?)([^\s,"{[}\]]+?)\s*(?=,|})/gs,'$1"$3"')}}cancelEditLSItem(t){let e=this.findLSItem(t);if(!e)return;e.classList.remove("editing"),e.querySelector(".ls-value").style.display="block",e.querySelector(".ls-edit").style.display="none";let o=e.querySelector(".ls-value-type");o&&(o.style.display="block"),this.renderLocalStorage()}removeLSItem(t){if(!confirm(`确定要删除键"${t}"吗？`))return;localStorage.removeItem(t);let e=this.findLSItem(t);e&&(e.remove(),this.showNotification(`已删除"${t}"`,"warning"),this.renderLocalStorage())}findLSItem(t){return this.overlay.querySelector(`.ls-item[data-key="${t}"]`)}updateLSItemView(t){let e=this.findLSItem(t);if(!e)return;let o=localStorage.getItem(t);if(null===o)return void e.remove();let s,i=!1;try{s=JSON.parse(o),s&&"object"==typeof s&&(i=!0)}catch{}let n=i?"JSON":typeof o;e.innerHTML=`<div class="ls-key-row"><div class="ls-key" title="${t}">${t}</div><div class="ls-actions"><button class="ls-action-btn" onclick="thinConsole.tC.editLSItem('${t}')" title="编辑"><i class="fa fa-edit"></i></button><button class="ls-action-btn" onclick="thinConsole.tC.copyLog('${t}','',true)" title="复制"><i class="fa fa-copy"></i></button><button class="ls-action-btn" onclick="thinConsole.tC.removeLSItem('${t}')" title="删除"><i class="fa fa-trash"></i></button></div></div><div class="ls-value" title="${o}">${o.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div><div class="ls-value-type" title="${n}">类型:${n}</div><div class="ls-edit"><textarea class="ls-edit-input">${o.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</textarea><div class="ls-edit-actions"><button class="ls-action-btn" title="取消" onclick="thinConsole.tC.cancelEditLSItem('${t}')">取消</button><button class="ls-action-btn" title="保存" onclick="thinConsole.tC.saveLSItem('${t}')">保存</button></div></div>`}setupGlobalEventHandlers(){this.activeFilter="all",this.searchQuery="",this.tCError=t=>{""!==t.filename||0!==t.lineno||0!==t.colno?(this.error(t.error.toString(),{"错误信息":t.message||"无信息","文件名":t.filename||"未知","位置":`${t.lineno}:${t.colno}`||"0:0","是否可信":t.isTrusted||!0,"类型":t.type||"error"}),t.preventDefault()):this.error("脚本错误")},this.tCUR=t=>{this.error("未处理的Promise异常",t.reason),t.preventDefault()},this.RSError=t=>{let e=new Set(["IMG","SCRIPT","LINK","VIDEO","AUDIO","SOURCE","TRACK"]),o=t.target;if(!e.has(o.tagName))return;let s=o.src||o.href||o.currentSrc||"[未知路径]";this.error(`[资源错误] <${o.tagName.toLowerCase()}>加载失败:${s}`)},document.addEventListener("error",this.RSError,!0),window.addEventListener("error",this.tCError),window.addEventListener("unhandledrejection",this.tCUR)}setupSelfProtection(){if(this.protectInterval)return;let t=this;this.protectInterval=setInterval(()=>{window.thinConsole&&window.thinConsole.tC!==t&&(window.thinConsole.tC=t);let e=document.getElementById("thinConsole-btn");e&&document.documentElement.contains(e)?"flex"!==e.style.display&&(e.style.display="flex"):(t.btn=null,t.createButton());let s=document.getElementById("consoleOverlay");s&&document.documentElement.contains(s)?"flex"!==s.style.display&&(s.style.display="flex"):(t.overlay=null,t.createOverlayElement(),t.createStyles()),document.head.querySelector("style[tcstyle]")||t.createStyles();let i=document.getElementById("notification");i&&document.documentElement.contains(i)?"block"!==i.style.display&&(i.style.display="block"):(t.notification=null,t.createNotificationElement());let o=e=>{if(!e||1!==e.nodeType)return;let t=t=>{"false"!==t.contentEditable&&(t.contentEditable="false",t.dataset.tcLock="1",n.observe(t,{attributes:!0,attributeFilter:["contenteditable"]}))};t(e),e.querySelectorAll("*").forEach(t)},n=new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"contentEditable"===e.attributeName&&"true"===e.target.contentEditable&&e.target.dataset.tcLock&&(e.target.contentEditable="false")})});setTimeout(()=>{o(t.btn),o(t.overlay),o(t.notification)},0)},5e3)}disablePlugin(t){return this.disabledPlugins.includes(t)||this.disabledPlugins.push(t),this.destroyPlugin(t),this}enablePlugin(t){return this.disabledPlugins=this.disabledPlugins.filter(e=>e!==t),this.loadSinglePlugin(t),this}loadSinglePlugin(t){if(!this.disabledPlugins.includes(t)&&thinConsole.plugins[t]&&!this.plugins[t]){try{let e=thinConsole.plugins[t],o=new e(this,e.config);if(o.init(),this.plugins[t]=o,o.addTab){let e=o.addTab();this.createPluginTab(e),this.pluginTabs[t]={id:e.id,name:e.name,icon:e.icon||"fa fa-plug",plugin:o}}this.triggerGlobalHook("pluginMount",t,o)}catch(e){console.error(`插件"${t}"加载失败:`,e)}return this}}initPlugins(){return Object.keys(thinConsole.plugins).forEach(t=>{this.disabledPlugins.includes(t)||this.loadSinglePlugin(t)}),this}destroyPlugin(t){let e=this.plugins[t];if(!e)return;"function"==typeof e.destroy&&e.destroy();let o=this.pluginTabs[t]?.id;if(o){let t=this.overlay.querySelector(`.tab-btn[data-tab="${o}"]`);t?.remove();let e=this.pluginViewContainers[o];e?.remove(),delete this.pluginViewContainers[o]}return delete this.plugins[t],delete this.pluginTabs[t],this.triggerGlobalHook("pluginUnmount",t),this}triggerGlobalHook(t,...e){return thinConsole.hooks[t]&&thinConsole.hooks[t].forEach(o=>{try{o.call(this,...e)}catch(e){console.error(`钩子"${t}"执行错误:`,e)}}),this}initShortcuts(){document.addEventListener("keydown",t=>{t.ctrlKey&&t.shiftKey&&"c"===t.key.toLowerCase()&&(t.preventDefault(),this.overlay||this.createOverlayElement(),this.triggerGlobalHook("beforeOpen"),this.overlay.classList.add("active","theme-"+this.currentTheme),this.renderContent(),this.triggerGlobalHook("afterOpen"),this.enableShortcuts())}),this.enableShortcuts=()=>{this.shortcutHandler||(this.shortcutHandler=t=>this.handlePanelShortcuts(t),document.addEventListener("keydown",this.shortcutHandler))},this.disableShortcuts=()=>{this.shortcutHandler&&(document.removeEventListener("keydown",this.shortcutHandler),this.shortcutHandler=null)},thinConsole.addHook("afterClose",()=>this.disableShortcuts())}handlePanelShortcuts(t){let e=t.target,o="INPUT"===e.tagName||"TEXTAREA"===e.tagName,s=t.key.toLowerCase();if("Escape"===t.key)return t.preventDefault(),void this.closeConsoleBtn.click();if(t.ctrlKey&&"enter"===s){let e=this.overlay.querySelector('.ls-item.editing .ls-edit-actions button[data-action="save"]');return void(e&&(t.preventDefault(),e.click()))}if(!t.altKey||t.shiftKey||t.ctrlKey)if(t.altKey&&t.shiftKey&&!t.ctrlKey)switch(s){case"c":t.preventDefault(),this.switchTab("console");break;case"s":t.preventDefault(),this.switchTab("system");break;case"l":t.preventDefault(),this.switchTab("localstorage")}else"/"!==s||o||(t.preventDefault(),this.searchInput.focus());else switch(s){case"c":t.preventDefault(),this.clearLogsBtn.click();break;case"a":case"l":case"i":case"w":case"e":t.preventDefault();let e={a:"all",l:"log",i:"info",w:"warn",e:"error"},o=Array.from(this.filterButtons).find(t=>t.dataset.type===e[s]);o&&o.click()}}switchTab(t){let e=Array.from(this.tabButtons).find(e=>e.dataset.tab===t);e&&e.click()}destroy(){thinConsole.tC===this&&(Object.assign(console,this.originalConsole),Object.keys(this.plugins).forEach(t=>this.destroyPlugin(t)),clearInterval(this.protectInterval),clearInterval(this.themeChangeHandler),this.btn?.remove(),this.overlay?.remove(),this.notification?.remove(),document.head.querySelector("style[tcstyle]").remove(),document.removeEventListener("error",this.RSError,!0),window.removeEventListener("error",this.tCError),window.removeEventListener("unhandledrejection",this.tCUR),this.disableShortcuts(),this.globalKeyHandler&&(document.removeEventListener("keydown",this.globalKeyHandler),this.globalKeyHandler=null),thinConsole.tC=null)}log(...t){return console.log(...t),this}info(...t){return console.info(...t),this}warn(...t){return console.warn(...t),this}error(...t){return console.error(...t),this}systemLog(...t){return console.log("[system]",...t),this}systemInfo(...t){return console.info("[system]",...t),this}systemWarn(...t){return console.warn("[system]",...t),this}systemError(...t){return console.error("[system]",...t),this}show(t="console"){return this.overlay||this.createOverlayElement(),this.switchTab(t),this.triggerGlobalHook("beforeOpen"),this.overlay.classList.add("active","theme-"+this.currentTheme),this.triggerGlobalHook("afterOpen"),this}hide(){return this.overlay&&(this.triggerGlobalHook("beforeClose"),this.overlay.classList.remove("active"),this.triggerGlobalHook("afterClose")),this}}thinConsole.plugins={},window.thinConsole=thinConsole,thinConsole.tC=null,thinConsole.hooks={beforeRender:[],afterRender:[],beforeLog:[],afterLog:[],beforeOpen:[],afterOpen:[],beforeClose:[],afterClose:[],beforeClear:[],afterClear:[],pluginMount:[],pluginUnmount:[]},thinConsole.addPlugin=function(t,e,o={}){if(thinConsole.tC){if(e.prototype instanceof tCPlugin){if(e.config=o,thinConsole.plugins[t]=e,thinConsole.tC.disabledPlugins.includes(t))return;if(thinConsole.tC.pluginEnabled&&!thinConsole.tC.plugins[t])try{let s=new e(thinConsole.tC,o);if(s.init(),thinConsole.tC.plugins[t]=s,s.addTab){let e=s.addTab();thinConsole.tC.pluginTabs[t]={id:e.id,name:e.name,icon:e.icon||"fa fa-tool",plugin:s},thinConsole.tC.createPluginTab(e)}thinConsole.tC.triggerGlobalHook("pluginMount",t,s)}catch(e){console.error(`插件"${t}"动态加载失败:`,e)}}else{if("function"!=typeof e)throw new Error(`插件"${t}"必须是类或函数类型`);if(!thinConsole.tC.options.plugins||thinConsole.tC.disabledPlugins.includes(t))return;try{e.call(null,thinConsole.tC,o),thinConsole.tC.triggerGlobalHook("pluginMount",t,null)}catch(e){console.error(`函数插件"${t}"执行失败:`,e)}}return thinConsole}},thinConsole.addHook=function(t,e){return thinConsole.hooks[t]&&!thinConsole.hooks[t].includes(e)?thinConsole.hooks[t].push(e):console.warn(`未知钩子:${t}`),thinConsole},thinConsole.removeHook=function(t,e){return thinConsole.hooks[t]&&(thinConsole.hooks[t]=thinConsole.hooks[t].filter(t=>t!==e)),thinConsole};class tCPlugin{constructor(t,e={}){if(!(t instanceof thinConsole))throw new Error("插件必须绑定到thinConsole实例");this.tC=t,this.config=e,this.id=this.constructor.name.toLowerCase()}init(){}iszh(){return!0}isen(){return!1}isMobile(){return/iPad|Android(?!.*Mobile)|Mobi|Android|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}render(t){}onShow(){}onHide(){}destroy(){}}